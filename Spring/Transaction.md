## 트랜잭션

* 트랜잭션은 데이터베이스의 상태를 변환시키는 하나의 논리적 기능을 수행하기 위한 작업의 단위 또는 한꺼번에 모두 수행되어야 할 일련의 연산들을 의미한다

### 트랜잭션의 특징

1. 트랜잭션은 데이터베이스 시스템이서 병행 제어 및 회복 작업 시 처리되는 작업의 논리적 단위이다

2. 사용자가 시스템에 대한 서비스 요구 시 시스템이 응답하기 위한 상태 변환 과정의 작업단위이다

3. 하나의 트랜잭션은 COMMIT 되거나 ROLLBACK된다

### 트랜잭션의 성질

* 원자성(Atomicity)
    * 트랜잭션의 연산은 데이터베이스에 모두 반영되든지 아니면 전혀 반영되지 않아야 한다

    * 트랜잭션 내의 모든 명령은 반드시 완벽히 수행되어야 하며, 모두가 완벽히 수행되지 않고 어느 하나라도 오류가 발생하면 트랜잭션 전부가 취소되어야 한다

* 일관성(Consistency)
    * 트랜잭션이 그 실행을 성공적으로 완료하면 언제나 일관성 있는 데이터베이스 상태로 변환한다

    * 시스템이 가지고 있는 고정요소는 트랜잭션 수행 전과 트랜잭션 수행 완료 후의 상태가 같아야 한다

* 독립성(Isolation)
    * 둘 이상의 트랜잭션이 동시에 병행 실행되는 경우 어느 하나의 트랜잭션 실행 중에 다른 트랜잭션의 연산이 끼어들 수 없다

    * 수행중인 트랜잭션은 완전히 환료될 때까지 다른 트랜잭션에서 수행 결과를 참조할 수 없다

* 지속성(Durability)
    * 성공적으로 완료된 트랜잭션의 결과는 시스템이 고장나더라도 영구적으로 반영되어야 한다

### 트랜잭션 연산

* Commit 연산
    * Commit 연산은 한개의 논리적 단위에 대한 작업이 성공적으로 끝났고 데이터베이스가 다시 일관된 상태에 있을 때, 트랜잭션이 행한 갱신 연산이 완료된 것을 트랜잭션 관리자에게 알려주는 연산이다

* Rollback 연산
    * Rollback 연산은 하나의 트랜잭션 처리가 비정상적으로 종료되어 데이터베이스의 일관성을 깨뜨렸을 때, 트랜잭션의 일부가 정상적으로 처리되었더라도 트랜잭션의 원자성을 구성하기 위해 이 트랜잭션이 행한 모든 연산들을 취소하는 연산이다

    * Rollback시에는 해당 트랜잭션을 재시작하거나 폐기한다

###  스프링이 제공하는 3가지 Transaction 핵심 기술

1. 트랜잭션 동기화
    * 트랜잭션을 시작하기 위한 Connection 객체를 특별한 저장소에 보관해두고 필요할 때 꺼내쓸 수 있도록 하는 기술이다

    * 트랜잭션 동기화 저장소는 작업 스레드마다 Connection 객체를 독립적으로 관리하기 때문에 멀티스레드 환경에서 충돌이 발생할 여지가 없다

    * 코드 예시
    ```Java
    // 동기화 시작
    TransactionSynchronizeManager.initSynchronization();
    Connnection c = DataSourceUtils.getConnection(dataSource);

    // 작업 진행

    // 동기화 종료
    DataSourceUtils.releaseConnection(c, dataSource);
    TransactionSynchronizeManager.unbindResource(dataSource);
    TransactionSynchronizeManager.clearSynchronization();
    ```

2. 트랜잭션 추상화
    * Spring은 트랜잭션 기술의 공통점을 담은 트랜잭션 추상화 기술을 제공하며, 이를 이용해 각 기술마다 종속적인 코드를 이용하지 않고도 일관되게 트랜잭션을 처리할 수 있도록 해주고 있다

    * ![트랜잭션](https://cdn.discordapp.com/attachments/951334644710776843/1029704758941990945/58f5fb673e1e6116.png)

        * 트랜잭션 경계 설정을 위한 추상 인터페이스는 PlatformTransactionManager이다(트랜잭션을 공유하고, 커밋하고, 롤백할 수 있게 되었다)

        * JDBC의 로컬 트랜잭션을 이용한다면 DataSourceTxManager를 이용하면 된다

3. AOP를 이용한 트랜잭션 분리
    * 트랜잭션 코드와 비지니스 로직 코드가 복잡하게 얽혀있는 로직을 클래스 밖으로 빼내서 별도의 모듈로 만드는 AOP방식을 이용하여 트랜잭션 어노테이션을 지원할 수 있도록 하였다